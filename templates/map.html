<!DOCTYPE html>
<html>
<head>
  <title>Epic Enclaves Map</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .map-container {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    .map {
      position: absolute;
      background-color: #f0f0f0;
    }
    .tile {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #fff;
      border: 1px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      cursor: pointer;
    }
    .entity {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #ccc;
      border: 1px solid #999;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      flex-direction: column;
    }
    .player { background-color: #8bc34a; }
    .current-user { background-color: #ff9800; }
    .forest { background-color: #4caf50; }
    .mountain { background-color: #795548; }
    .troll { background-color: #9c27b0; }
    .wraith { background-color: #607d8b; }
    .text-label {
      text-align: center;
      width: 100%;
      font-size: 10px;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map" class="map"></div>
  </div>

  <script>
    const jsonData = {% raw data %};
    const currentUser = '{{ user }}';
    const gridSize = 50;
    const verticalTiles = 20; // Keep vertical size the same

    let horizontalTiles;

    function calculateHorizontalTiles() {
      const mapContainer = document.querySelector('.map-container');
      horizontalTiles = Math.ceil(mapContainer.offsetWidth / gridSize) + 4; // Add extra tiles for smoother scrolling
    }

    function createMap(data) {
      const mapContainer = document.getElementById("map");
      const fragment = document.createDocumentFragment();

      function createTile(x, y) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.style.top = y * gridSize + "px";
        tile.style.left = x * gridSize + "px";
        tile.dataset.x = x;
        tile.dataset.y = y;
        fragment.appendChild(tile);
        return tile;
      }

      function createEntity(className, x, y, content) {
        const element = document.createElement("div");
        element.className = `entity ${className}`;
        element.style.top = y * gridSize + "px";
        element.style.left = x * gridSize + "px";
        element.appendChild(content);
        fragment.appendChild(element);
        return element;
      }

      function createEntityContent(entity, pos) {
        const content = document.createElement("div");
        content.className = "text-label";
        let infoText = `${entity.type}`;
        if (entity.level !== undefined) infoText += ` Lvl${entity.level}`;
        if (entity.hp !== undefined) infoText += ` HP${entity.hp}`;
        if (entity.exp !== undefined) infoText += ` Exp${entity.exp}`;
        if (entity.armor !== undefined) infoText += ` Arm${entity.armor}`;
        infoText += `\n(${pos.x},${pos.y})`;
        content.innerText = infoText;
        return content;
      }

      function createVisibleTiles() {
        const currentUserData = jsonData.users[currentUser];
        if (currentUserData) {
          const { x_pos, y_pos } = currentUserData;
          const halfWidth = Math.floor(horizontalTiles / 2);
          const halfHeight = Math.floor(verticalTiles / 2);

          for (let y = Math.max(0, y_pos - halfHeight); y < y_pos + halfHeight; y++) {
            for (let x = Math.max(0, x_pos - halfWidth); x < x_pos + halfWidth; x++) {
              createTile(x, y);
            }
          }
        }
      }

      createVisibleTiles();

      Object.entries(data.users).forEach(([username, user]) => {
        const content = createEntityContent(user, {x: user.x_pos, y: user.y_pos});
        const className = `player ${username === currentUser ? 'current-user' : ''}`;
        createEntity(className, user.x_pos - 1, user.y_pos - 1, content);
      });

      Object.entries(data.construction).forEach(([key, construction]) => {
        const [x_pos, y_pos] = key.split(",").map(Number);
        const content = createEntityContent(construction, {x: x_pos, y: y_pos});
        createEntity(construction.type, x_pos - 1, y_pos - 1, content);
      });

      mapContainer.appendChild(fragment);
      centerMapOnPlayer();
    }

    function updateMap(data) {
      const mapContainer = document.getElementById("map");
      mapContainer.innerHTML = '';
      createMap(data);
    }

    function moveToPosition(x, y, callback) {
      // Simulating movement without actual server request
      jsonData.users[currentUser].x_pos = x;
      jsonData.users[currentUser].y_pos = y;
      updateMap(jsonData);
      callback(true);
    }

    function addClickListenerToMap() {
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", (event) => {
        if (event.target.classList.contains("tile") || event.target.closest(".entity")) {
          const clickedElement = event.target.classList.contains("tile") ? event.target : event.target.closest(".entity");
          const clickX = parseInt(clickedElement.style.left) / gridSize + 1;
          const clickY = parseInt(clickedElement.style.top) / gridSize + 1;

          moveToPosition(clickX, clickY, (success) => {
            if (success) {
              updateMap(jsonData);
            }
          });
        }
      });
    }

    function centerMapOnPlayer() {
      const currentUserData = jsonData.users[currentUser];
      if (currentUserData) {
        const { x_pos, y_pos } = currentUserData;
        const mapContainer = document.querySelector('.map-container');
        const map = document.getElementById('map');

        const containerWidth = mapContainer.offsetWidth;
        const containerHeight = mapContainer.offsetHeight;

        const leftOffset = (x_pos - 1) * gridSize - (containerWidth / 2) + (gridSize / 2);
        const topOffset = (y_pos - 1) * gridSize - (containerHeight / 2) + (gridSize / 2);

        map.style.left = `${-leftOffset}px`;
        map.style.top = `${-topOffset}px`;
      }
    }

    window.addEventListener('resize', () => {
      calculateHorizontalTiles();
      updateMap(jsonData);
    });

    calculateHorizontalTiles();
    createMap(jsonData);
    addClickListenerToMap();
  </script>
</body>
</html>