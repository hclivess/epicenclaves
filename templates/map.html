<!DOCTYPE html>
<html>
<head>
  <title>Epic Enclaves Map</title>
  <style>
    .map {
      position: relative;
      width: 100%;
      height: 600px;
      background-color: #f0f0f0;
    }
    .tile {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #fff;
      border: 1px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      cursor: pointer;
    }
    .entity {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #ccc;
      border: 1px solid #999;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
    }
    .player {
      background-color: #8bc34a;
    }
    .current-user {
      background-color: #ff9800;
    }
    .text-label {
      text-align: center;
    }
    .map-container {
      overflow: auto;
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map" class="map"></div>
  </div>

  <script>
    const jsonData = {% raw data %};
    const currentUser = '{{ user }}';
    const gridSize = 50;
    const initialMapSize = 20;

    let mapWidth = initialMapSize;
    let mapHeight = initialMapSize;

    function createMap(data) {
      const mapContainer = document.getElementById("map");
      const fragment = document.createDocumentFragment();

      function createTile(x, y) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.style.top = y * gridSize + "px";
        tile.style.left = x * gridSize + "px";
        tile.dataset.x = x;
        tile.dataset.y = y;
        fragment.appendChild(tile);
        return tile;
      }

      function createEntity(className, x, y, content) {
        const element = document.createElement("div");
        element.className = className;
        element.style.top = y * gridSize + "px";
        element.style.left = x * gridSize + "px";
        element.appendChild(content);
        fragment.appendChild(element);
        return element;
      }

      function createUserEntity(username, user) {
        const content = document.createElement("div");
        const playerLabel = document.createElement("div");
        playerLabel.className = "text-label";
        playerLabel.innerHTML = `${username}<br>exp: ${user.exp}<br>hp: ${user.hp}`;
        content.appendChild(playerLabel);

        const entityClass = username === currentUser ? "entity player current-user" : "entity player";
        createEntity(entityClass, user.x_pos - 1, user.y_pos - 1, content);
      }

      function createVisibleTiles() {
        const currentUserData = jsonData.users[currentUser];
        if (currentUserData) {
          const { x_pos, y_pos } = currentUserData;
          const halfWidth = Math.floor(mapWidth / 2);
          const halfHeight = Math.floor(mapHeight / 2);

          for (let y = Math.max(0, y_pos - halfHeight); y <= y_pos + halfHeight; y++) {
            for (let x = Math.max(0, x_pos - halfWidth); x <= x_pos + halfWidth; x++) {
              createTile(x, y);
            }
          }
        }
      }

      createVisibleTiles();

      Object.entries(data.users).forEach(([username, user]) => {
        if (user.type === "player") {
          createUserEntity(username, user);
        }
      });

      Object.entries(data.construction).forEach(([key, construction]) => {
        const [x_pos, y_pos] = key.split(",").map(Number);
        const content = document.createElement("div");
        content.className = "text-label";
        content.innerHTML = `${construction.type}<br>level: ${construction.level || '-'}`;
        createEntity(`entity construction ${construction.type}`, x_pos - 1, y_pos - 1, content);
      });

      mapContainer.appendChild(fragment);
      adjustMapSize();
    }

    function updateMap(data) {
      const mapContainer = document.getElementById("map");
      mapContainer.innerHTML = '';
      createMap(data);
    }

    function moveToPosition(x, y, callback) {
      fetch(`/move_to?x=${x}&y=${y}&target=map`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        Object.assign(jsonData, data);
        updateMap(jsonData);

        if (data.message) {
          const messageDisplay = document.getElementById('message-display');
          if (messageDisplay) {
            messageDisplay.textContent = data.message;
          }
        }

        const success = data.message === "Moved successfully";
        callback(success);
      })
      .catch((error) => {
        console.error('Error:', error);
        callback(false);
      });
    }

    function addClickListenerToMap() {
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", (event) => {
        if (event.target.classList.contains("tile")) {
          const clickX = parseInt(event.target.dataset.x) + 1;
          const clickY = parseInt(event.target.dataset.y) + 1;

          moveToPosition(clickX, clickY, (success) => {
            if (success) {
              updateMap(jsonData);
            }
          });
        }
      });
    }

    function adjustMapSize() {
      const currentUserData = jsonData.users[currentUser];
      if (currentUserData) {
        const { x_pos, y_pos } = currentUserData;

        if (x_pos > mapWidth / 2) {
          mapWidth = x_pos * 2;
        }
        if (y_pos > mapHeight / 2) {
          mapHeight = y_pos * 2;
        }

        const mapContainer = document.getElementById("map");
        mapContainer.style.width = (mapWidth * gridSize) + "px";
        mapContainer.style.height = (mapHeight * gridSize) + "px";
      }
    }

    createMap(jsonData);
    addClickListenerToMap();
  </script>
</body>
</html>