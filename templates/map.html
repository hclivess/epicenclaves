<!DOCTYPE html>
<html>
<head>
  <title>Epic Enclaves Map</title>
  <style>
    .map {
      position: relative;
      width: 100%;
      height: 600px;
      background-color: #f0f0f0;
    }
    .entity {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #ccc;
      border: 1px solid #999;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
    }
    .player {
      background-color: #8bc34a;
    }
    .current-user {
      background-color: #ff9800;
    }
    .text-label {
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map" class="map"></div>

  <script>
    const jsonData = {% raw data %};
    const currentUser = '{{ user }}';
    const gridSize = 50;

    function createMap(data) {
      const mapContainer = document.getElementById("map");
      const fragment = document.createDocumentFragment();

      function createEntity(className, x, y, content) {
        const element = document.createElement("div");
        element.className = className;
        element.style.top = y * gridSize + "px";
        element.style.left = x * gridSize + "px";
        element.appendChild(content);
        fragment.appendChild(element);
        return element;
      }

      function createUserEntity(username, user) {
        const content = document.createElement("div");
        const playerLabel = document.createElement("div");
        playerLabel.className = "text-label";
        playerLabel.innerHTML = `${username}<br>exp: ${user.exp}<br>hp: ${user.hp}`;
        content.appendChild(playerLabel);

        const entityClass = username === currentUser ? "entity player current-user" : "entity player";
        createEntity(entityClass, user.x_pos - 1, user.y_pos - 1, content);
      }

      Object.entries(data.users).forEach(([username, user]) => {
        if (user.type === "player") {
          createUserEntity(username, user);
        }
      });

      Object.entries(data.construction).forEach(([key, construction]) => {
        const [x_pos, y_pos] = key.split(",").map(Number);
        const content = document.createElement("div");
        content.className = "text-label";
        content.innerHTML = `${construction.type}<br>level: ${construction.level || '-'}`;
        createEntity(`entity construction ${construction.type}`, x_pos - 1, y_pos - 1, content);
      });

      mapContainer.appendChild(fragment);
    }

    function updateMap(data) {
      const mapContainer = document.getElementById("map");
      mapContainer.innerHTML = '';
      createMap(data);
    }

    function moveToPosition(x, y, callback) {
      fetch(`/move_to?x=${x}&y=${y}&target=map`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        Object.assign(jsonData, data);
        updateMap(jsonData);

        if (data.message) {
          const messageDisplay = document.getElementById('message-display');
          if (messageDisplay) {
            messageDisplay.textContent = data.message;
          }
        }

        const success = data.message === "Moved successfully";
        callback(success);
      })
      .catch((error) => {
        console.error('Error:', error);
        callback(false);
      });
    }

    function addClickListenerToMap() {
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", (event) => {
        const rect = mapContainer.getBoundingClientRect();
        const clickX = Math.floor((event.clientX - rect.left) / gridSize) + 1;
        const clickY = Math.floor((event.clientY - rect.top) / gridSize) + 1;

        moveToPosition(clickX, clickY, (success) => {
          if (success) {
            updateMap(jsonData);
          }
        });
      });
    }

    createMap(jsonData);
    addClickListenerToMap();
  </script>
</body>
</html>