<!DOCTYPE html>
<html>
<head>
  <title>Epic Enclaves Map</title>
  <style>
    .dragon { background: url('img/assets/dragon.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .goblin { background: url('img/assets/goblin.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .specter { background: url('img/assets/specter.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .dragon_whelp { background: url('img/assets/dragon_whelp.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .bandit { background: url('img/assets/bandit.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .troll { background: url('img/assets/troll.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .harpy { background: url('img/assets/harpy.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .minotaur { background: url('img/assets/minotaur.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wraith { background: url('img/assets/wraith.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .boar { background: url('img/assets/boar.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .forest { background: url('img/assets/forest.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .mountain { background: url('img/assets/mountain.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wall { background: url('img/assets/wall.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wolf { background: url('img/assets/wolf.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .inn { background: url('img/assets/inn.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .barracks { background: url('img/assets/barracks.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .sawmill { background: url('img/assets/sawmill.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .house { background: url('img/assets/house.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .farm { background: url('img/assets/farm.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .mine { background: url('img/assets/mine.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .blacksmith { background: url('img/assets/blacksmith.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .map-container {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    .map {
      position: absolute;
      background-color: #f0f0f0;
    }
    .tile {
      position: absolute;
      width: 80px;
      height: 80px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      cursor: pointer;
      overflow: hidden;
    }
    .entity {
      position: absolute;
      width: 80px;
      height: 80px;
      border: 1px solid #999;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 12px;
      flex-direction: column;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <div id="map" class="map"></div>
  </div>

  <script>
    const jsonData = {% raw data %};
    const currentUser = '{{ user }}';
    const gridSize = 80;
    const verticalTiles = 20;

    let horizontalTiles;

    function calculateHorizontalTiles() {
      const mapContainer = document.querySelector('.map-container');
      horizontalTiles = Math.ceil(mapContainer.offsetWidth / gridSize) + 4;
    }

    function createMap(data) {
      const mapContainer = document.getElementById("map");
      const fragment = document.createDocumentFragment();

      function createTile(x, y) {
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.style.top = y * gridSize + "px";
        tile.style.left = x * gridSize + "px";
        tile.dataset.x = x;
        tile.dataset.y = y;
        fragment.appendChild(tile);
        return tile;
      }

      function createEntity(className, x, y, imgUrl) {
        const element = document.createElement("div");
        element.className = `entity ${className}`;
        element.style.top = y * gridSize + "px";
        element.style.left = x * gridSize + "px";

        if (imgUrl) {
          element.style.backgroundImage = `url('${imgUrl}')`;
        }

        fragment.appendChild(element);
        return element;
      }

      function getEntityClassName(entity, username) {
        let className = entity.type.toLowerCase();
        if (entity.type === 'player' && username === currentUser) {
          className += ' current-user';
        }
        return className;
      }

      function createVisibleTiles() {
        const currentUserData = data.users[currentUser];
        if (currentUserData) {
          const { x_pos, y_pos } = currentUserData;
          const halfWidth = Math.floor(horizontalTiles / 2);
          const halfHeight = Math.floor(verticalTiles / 2);

          for (let y = Math.max(0, y_pos - halfHeight); y < y_pos + halfHeight; y++) {
            for (let x = Math.max(0, x_pos - halfWidth); x < x_pos + halfWidth; x++) {
              createTile(x, y);
            }
          }
        }
      }

      createVisibleTiles();

      Object.entries(data.users).forEach(([username, user]) => {
        const className = getEntityClassName(user, username);
        createEntity(className, user.x_pos - 1, user.y_pos - 1, user.img);
      });

      Object.entries(data.construction).forEach(([key, construction]) => {
        const [x_pos, y_pos] = key.split(",").map(Number);
        const className = getEntityClassName(construction);
        createEntity(className, x_pos - 1, y_pos - 1);
      });

      mapContainer.appendChild(fragment);
      centerMapOnPlayer();
    }

    function updateMap(data) {
      const mapContainer = document.getElementById("map");
      mapContainer.innerHTML = '';
      createMap(data);
    }

    function moveToPosition(x, y, callback) {
      // Simulating movement without actual server request
      jsonData.users[currentUser].x_pos = x;
      jsonData.users[currentUser].y_pos = y;
      updateMap(jsonData);
      callback(true);
    }

    function addClickListenerToMap() {
      const mapContainer = document.getElementById("map");
      mapContainer.addEventListener("click", (event) => {
        if (event.target.classList.contains("tile") || event.target.closest(".entity")) {
          const clickedElement = event.target.classList.contains("tile") ? event.target : event.target.closest(".entity");
          const clickX = parseInt(clickedElement.style.left) / gridSize + 1;
          const clickY = parseInt(clickedElement.style.top) / gridSize + 1;

          moveToPosition(clickX, clickY, (success) => {
            if (success) {
              updateMap(jsonData);
            }
          });
        }
      });
    }

    function centerMapOnPlayer() {
      const currentUserData = jsonData.users[currentUser];
      if (currentUserData) {
        const { x_pos, y_pos } = currentUserData;
        const mapContainer = document.querySelector('.map-container');
        const map = document.getElementById('map');

        const containerWidth = mapContainer.offsetWidth;
        const containerHeight = mapContainer.offsetHeight;

        const leftOffset = (x_pos - 1) * gridSize - (containerWidth / 2) + (gridSize / 2);
        const topOffset = (y_pos - 1) * gridSize - (containerHeight / 2) + (gridSize / 2);

        map.style.left = `${-leftOffset}px`;
        map.style.top = `${-topOffset}px`;
      }
    }

    window.addEventListener('resize', () => {
      calculateHorizontalTiles();
      updateMap(jsonData);
    });

    calculateHorizontalTiles();
    createMap(jsonData);
    addClickListenerToMap();
  </script>
</body>
</html>