<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Enclaves Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>

        .dragon { background: url('img/assets/dragon.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .goblin { background: url('img/assets/goblin.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .specter { background: url('img/assets/specter.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .dragon_whelp { background: url('img/assets/dragon_whelp.png') center/cover no-repeat, linear-gradient(to bottom, rgba(255, 215, 0, 0.5), rgba(0, 0, 0, 0.5)); }
    .bandit { background: url('img/assets/bandit.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .troll { background: url('img/assets/troll.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .harpy { background: url('img/assets/harpy.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .minotaur { background: url('img/assets/minotaur.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wraith { background: url('img/assets/wraith.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .boar { background: url('img/assets/boar.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .forest { background: url('img/assets/forest.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .mountain { background: url('img/assets/mountain.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wall { background: url('img/assets/wall.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .wolf { background: url('img/assets/wolf.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .inn { background: url('img/assets/inn.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .barracks { background: url('img/assets/barracks.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .sawmill { background: url('img/assets/sawmill.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .house { background: url('img/assets/house.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .farm { background: url('img/assets/farm.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .mine { background: url('img/assets/mine.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }
    .blacksmith { background: url('img/assets/blacksmith.png') center/cover no-repeat, linear-gradient(to bottom, rgba(128, 128, 128, 0.5), rgba(0, 0, 0, 0.5)); }

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Merriweather', serif;
            background-color: #0a0a0a;
            background-image: url('img/assets/background_map.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .map-container {
            width: 100%;
            height: calc(100vh - 60px);
            overflow: hidden;
            position: relative;
            background-color: transparent;
        }
        .map {
            position: absolute;
            background-color: transparent;
        }
        .tile {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: transparent;
            border: 1px solid rgba(204, 204, 204, 0.5); /* Semi-transparent border */
            border-radius: 10px;
        }
        .entity {
            position: absolute;
            width: 80px;
            height: 80px;
            box-sizing: border-box;
            border: 3px solid;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: transform 0.3s ease, z-index 0.3s ease;
        }
        .entity:hover {
            transform: scale(1.1);
            z-index: 1000;
        }
        .entity.player {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
            z-index: 1000; /* Ensure player is always on top */
        }

        .exclamation-mark {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 30px;
            height: 30px;
            background-color: yellow;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            animation: glow 1s infinite alternate;
            z-index: 1001;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px yellow;
            }
            to {
                box-shadow: 0 0 20px yellow;
            }
        }

        .popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
        }
        }
        .entity.npc {
            border-color: #FF9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        .entity-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            padding: 2px;
            text-align: center;
            line-height: 1.2;
        }
        .navigation-submenu {
            background-color: #333;
            padding: 10px;
            text-align: center;
        }
        .btn {
            display: inline-block;
            padding: 6px 12px;
            margin: 0 2px;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.42857143;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-image: none;
            border: 1px solid transparent;
            border-radius: 4px;
            text-decoration: none;
            color: #fff;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
            border-color: #545b62;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>
<body>
    <div class="navigation-submenu">
        <a href="/move?direction=up&target=map" class="btn btn-primary">üîº Up</a>
        <a href="/move?direction=down&target=map" class="btn btn-primary">üîΩ Down</a>
        <a href="/move?direction=left&target=map" class="btn btn-primary">‚óÄÔ∏è Left</a>
        <a href="/move?direction=right&target=map" class="btn btn-primary">‚ñ∂Ô∏è Right</a>
        <a href="/" class="btn btn-secondary">üë§ User Panel</a>
        <a href="/map" class="btn btn-secondary">üîÑ Refresh</a>
        <a href="/scoreboard" class="btn btn-secondary">üèÜ Scores</a>
        <a href="/logout" class="btn btn-danger">üåô Logout</a>
    </div>

    <div class="map-container">
        <div id="map" class="map"></div>
    </div>

    <div id="popup" class="popup"></div>

    <script>
    const jsonData = {% raw data %};
    const currentUser = '{{ user }}';
        const gridSize = 80;
        const verticalTiles = 20;

        let horizontalTiles;

        function calculateHorizontalTiles() {
            const mapContainer = document.querySelector('.map-container');
            horizontalTiles = Math.ceil(mapContainer.offsetWidth / gridSize) + 4;
        }

        function createMap(data) {
            const mapContainer = document.getElementById("map");
            const fragment = document.createDocumentFragment();

            function createTile(x, y) {
                const tile = document.createElement("div");
                tile.className = "tile";
                tile.style.top = y * gridSize + "px";
                tile.style.left = x * gridSize + "px";
                tile.dataset.x = x;
                tile.dataset.y = y;
                fragment.appendChild(tile);
                return tile;
            }

            function createEntityLabel(entity, pos, isPlayer, playerName) {
                const label = document.createElement("div");
                label.className = "entity-label";
                let text = '';
                if (isPlayer) {
                    text = `${playerName} Exp:${entity.exp} HP:${entity.hp}`;
                } else {
                    text = `${entity.type}`;
                    if (entity.level !== undefined) text += ` Lvl${entity.level}`;
                }
                text += ` (${pos.x},${pos.y})`;
                label.textContent = text;
                return label;
            }

            function createEntity(className, x, y, entity, isPlayer = false, playerName = '') {
                const element = document.createElement("div");
                element.className = `entity ${className} ${isPlayer ? 'player' : 'npc'}`;
                element.style.top = y * gridSize + "px";
                element.style.left = x * gridSize + "px";

                if (entity.img) {
                    element.style.backgroundImage = `url('${entity.img}')`;
                }

                const label = createEntityLabel(entity, {x: x+1, y: y+1}, isPlayer, playerName);
                element.appendChild(label);

                if (isPlayer) {
                    const exclamationMark = document.createElement("div");
                    exclamationMark.className = "exclamation-mark";
                    exclamationMark.textContent = "!";
                    exclamationMark.style.display = "none";
                    element.appendChild(exclamationMark);
                }

                fragment.appendChild(element);
                return element;
            }

            function createVisibleTiles() {
                const currentUserData = data.users[currentUser];
                if (currentUserData) {
                    const { x_pos, y_pos } = currentUserData;
                    const halfWidth = Math.floor(horizontalTiles / 2);
                    const halfHeight = Math.floor(verticalTiles / 2);

                    for (let y = Math.max(0, y_pos - halfHeight); y < y_pos + halfHeight; y++) {
                        for (let x = Math.max(0, x_pos - halfWidth); x < x_pos + halfWidth; x++) {
                            createTile(x, y);
                        }
                    }
                }
            }

            createVisibleTiles();

            Object.entries(data.users).forEach(([username, user]) => {
                createEntity(user.type.toLowerCase(), user.x_pos - 1, user.y_pos - 1, user, true, username);
            });

            Object.entries(data.construction).forEach(([key, entity]) => {
                const [x, y] = key.split(",").map(Number);
                createEntity(entity.type.toLowerCase(), x - 1, y - 1, {...entity, x_pos: x, y_pos: y}, false);
            });

            mapContainer.appendChild(fragment);
            centerMapOnPlayer();
        }

    function updateMap(data) {
        const mapContainer = document.getElementById("map");
        mapContainer.innerHTML = '';
        createMap(data);
        checkPlayerPosition();
    }

         function checkPlayerPosition() {
        const currentUserData = jsonData.users[currentUser];
        if (currentUserData) {
            const { x_pos, y_pos } = currentUserData;
            const key = `${x_pos},${y_pos}`;
            const entityOnTile = jsonData.construction[key];

            const playerElement = document.querySelector('.entity.player');
            const exclamationMark = playerElement.querySelector('.exclamation-mark');
            const popup = document.getElementById('popup');

            if (entityOnTile) {
                exclamationMark.style.display = "flex";
                popup.textContent = `You are standing on: ${entityOnTile.type}`;
                popup.style.display = "block";
            } else {
                exclamationMark.style.display = "none";
                popup.style.display = "none";
            }
        }
    }

    function moveToPosition(x, y, callback) {
        fetch(`/move_to?x=${x}&y=${y}&target=map`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            Object.assign(jsonData, data);
            updateMap(jsonData);

            if (data.message) {
                const messageDisplay = document.getElementById('message-display');
                if (messageDisplay) {
                    messageDisplay.textContent = data.message;
                }
            }

            const success = data.message === "Moved successfully";
            callback(success);
            checkPlayerPosition();
        })
        .catch((error) => {
            console.error('Error:', error);
            callback(false);
        });
    }


        function addClickListenerToMap() {
            const mapContainer = document.getElementById("map");
            mapContainer.addEventListener("click", (event) => {
                if (event.target.classList.contains("tile") || event.target.closest(".entity")) {
                    const clickedElement = event.target.classList.contains("tile") ? event.target : event.target.closest(".entity");
                    const clickX = parseInt(clickedElement.style.left) / gridSize + 1;
                    const clickY = parseInt(clickedElement.style.top) / gridSize + 1;

                    moveToPosition(clickX, clickY, (success) => {
                        if (success) {
                            updateMap(jsonData);
                        }
                    });
                }
            });
        }

        function centerMapOnPlayer() {
            const currentUserData = jsonData.users[currentUser];
            if (currentUserData) {
                const { x_pos, y_pos } = currentUserData;
                const mapContainer = document.querySelector('.map-container');
                const map = document.getElementById('map');

                const containerWidth = mapContainer.offsetWidth;
                const containerHeight = mapContainer.offsetHeight;

                const leftOffset = (x_pos - 1) * gridSize - (containerWidth / 2) + (gridSize / 2);
                const topOffset = (y_pos - 1) * gridSize - (containerHeight / 2) + (gridSize / 2);

                map.style.left = `${-leftOffset}px`;
                map.style.top = `${-topOffset}px`;
            }
        }

        window.addEventListener('resize', () => {
            calculateHorizontalTiles();
            updateMap(jsonData);
        });

        calculateHorizontalTiles();
        createMap(jsonData);
        addClickListenerToMap();
    </script>
</body>
</html>